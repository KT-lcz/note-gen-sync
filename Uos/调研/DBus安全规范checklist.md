# DBus 安全审查模板 (多语言通用版)

## AI 使用说明

**核心指令**: 你的任务是 **必须遍历** 下表中的每一行。对于每一个"检查项ID"，你都必须基于项目代码和配置文件给出一个明确的"检查结果"，并提供翔实的"备注与证据"。**重点强调**：不要仅仅依赖关键字搜索，必须**理解代码语义**和**分析执行流程**。

## 🚨 特别要求：完成所有检查后，必须执行"命令调用专项审查"

| 检查项ID         | 类别            | 要求             | 检查内容                                                                       | 建议检查方法 (多语言通用)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | 要求原因/风险说明                                                       | 检查结果 (AI填写) | 备注与证据 (AI填写) |
| :--------------- | :-------------- | :--------------- | :----------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------- | :---------------- | :------------------ |
| **1.1.1**  | 配置-服务启动   | **必须项** | 项目中所有System bus服务必须通过systemd service启动                            | **【配置文件审查】** 1. 查找项目中的D-Bus服务文件(`*.service`)。 2. 读取文件，确认其中是否包含 `SystemdService=` 字段。                                                                                                                                                                                                                                                                                                                                                                                             | 未通过systemd启动的服务无法进行统一的权限和资源控制。                   |                   |                     |
| **1.1.2**  | 配置-服务启动   | **必须项** | DBus service配置文件(`.service`类型)包含 `SystemdService=` 字段            | **【配置文件审查】** 与 **1.1.1** 方法相同。                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 这是将DBus服务与systemd单元关联起来的标准方式。                         |                   |                     |
| **1.2.1**  | 配置-访问控制   | **必须项** | 每个interface和method都有对应的 `<allow>`或 `<deny>`规则，无宽泛授权       | **【配置文件审查】** 1. 查找并读取D-Bus安全策略配置文件(`*.conf`)。 2. 检查 `<policy context="default">`中是否存在宽泛的 `<allow send_destination="..."/>`规则，而非针对具体interface或method的规则。                                                                                                                                                                                                                                                                                                             | 缺乏精确控制可能导致任意用户调用特权接口，造成权限绕过。                |                   |                     |
| **1.2.2**  | 配置-访问控制   | **必须项** | `<policy context="default">`中不允许 `own`服务                             | **【配置文件审查】** 1. 查找并读取D-Bus安全策略配置文件(`*.conf`)。 2. 检查 `<policy context="default">`中是否包含 `<allow own=.../>`规则。                                                                                                                                                                                                                                                                                                                                                                       | `own`权限应在特定用户策略中授予，在default中授予等于无限制。          |                   |                     |
| **1.3.1**  | 配置-规范性     | **必须项** | systemd service的 `User`字段与dbus conf中 `allow own`的用户匹配            | **【配置文件审查】** 1. 定位systemd服务文件和D-Bus配置文件。 2. 检查systemd服务文件中的 `User=`字段（若无则为root）与D-Bus配置文件中 `<policy>`的 `user=`属性是否匹配。                                                                                                                                                                                                                                                                                                                                           | 配置不一致可能导致服务无法启动或出现非预期的权限异常。                  |                   |                     |
| **2.1.1**  | 代码-参数验证   | **必须项** | 所有DBus method的输入参数都有完整的类型、长度、范围、格式和内容校验            | **【代码语义分析】** 1. 通过接口定义文件、注解或代码结构定位所有D-Bus方法。 2. **理解每个方法的实现逻辑**，检查对输入参数是否存在校验逻辑（null检查、范围验证、格式校验等）。                                                                                                                                                                                                                                                                                                                                     | 参数验证不足是导致注入攻击、缓冲区溢出等漏洞的根源。                    |                   |                     |
| **2.1.2**  | 代码-参数验证   | **必须项** | 检查并过滤了注入字符：`~ < > " ' % ( ) & + \ ' "` 等                         | **【代码语义分析】** 在处理外部输入的代码中，**理解数据流向**，检查特殊字符是否在用于命令、路径或查询拼接前被过滤。重点分析字符串处理逻辑。                                                                                                                                                                                                                                                                                                                                                                       | 特殊字符可能被用于路径遍历、命令注入或跨站脚本等攻击。                  |                   |                     |
| **2.2.1**  | 代码-禁止的参数 | **必须项** | DBus接口不接受shell命令或可拼接成命令的字符串作为参数                          | **【数据流分析】** 1. 分析D-Bus方法的参数定义和用途。 2. **跟踪参数的使用路径**，确认是否被传递给命令执行函数。 3. 理解参数的语义含义，判断是否可能被恶意构造为命令。                                                                                                                                                                                                                                                                                                                                             | 直接接受命令字符串是最高风险的命令注入漏洞。                            |                   |                     |
| **2.2.2**  | 代码-禁止的参数 | **必须项** | DBus接口不接受文件路径作为参数，或对路径进行了严格的白名单校验                 | **【数据流分析】** 1. 识别所有接受字符串参数的D-Bus方法。 2. **理解参数语义**，确认哪些可能被解释为文件路径。 3. 跟踪路径参数的使用，确认是否经过规范化和白名单验证。                                                                                                                                                                                                                                                                                                                                             | 接受任意文件路径会导致任意文件读写漏洞和TOCTOU攻击。                    |                   |                     |
| **2.2.3**  | 代码-禁止的参数 | **必须项** | DBus接口不接受密码、token等敏感数据作为参数                                    | **【接口分析】** 审查所有D-Bus接口的参数列表，**理解参数的业务含义**，确认不包含敏感信息字段。                                                                                                                                                                                                                                                                                                                                                                                                                    | 特权服务中传输明文敏感信息会增加信息泄露的风险。                        |                   |                     |
| **2.3.1**  | 代码-调用者验证 | **必须项** | **禁止**使用 `/proc/${pid}/exe` 或 `/proc/${pid}/cmdline` 等进行验证 | **【代码语义分析】** **理解身份验证逻辑**，查找任何读取 `/proc/`目录信息用于验证调用者身份的代码。分析验证函数的实现原理。                                                                                                                                                                                                                                                                                                                                                                                      | 基于procfs的验证存在竞态条件，可被 `LD_PRELOAD`攻击轻易绕过。         |                   |                     |
| **2.3.2**  | 代码-调用者验证 | **必须项** | 代码中不包含任何可被 `LD_PRELOAD`绕过的自定义身份验证方法                    | **【代码审计】** **深入理解验证逻辑**，分析自定义身份验证函数的实现原理，判断是否依赖于可被伪造的信息（进程名、库函数调用等）。                                                                                                                                                                                                                                                                                                                                                                                   | 自定义的验证逻辑通常不安全，无法抵御库劫持等高级攻击。                  |                   |                     |
| **2.3.3**  | 代码-调用者验证 | **推荐项** | 优先使用 `org.freedesktop.DBus.GetConnectionCredentials` 获取调用者信息      | **【代码语义分析】** **理解调用者信息获取方式**，确认是否使用了DBus提供的标准安全接口，而非自定义方法。                                                                                                                                                                                                                                                                                                                                                                                                           | 这是DBus提供的标准、安全的获取调用者UID/GID的方式。                     |                   |                     |
| **2.4.1**  | 代码-环境变量   | **必须项** | 从调用者获取环境变量时进行白名单过滤，禁止直接传递给子进程                     | **【代码语义分析】** **理解进程创建逻辑**，分析子进程的环境变量来源，确认是否对继承的环境变量进行了清理和过滤。                                                                                                                                                                                                                                                                                                                                                                                                   | 环境变量是不可信的输入，可能导致 `PATH`劫持或 `LD_PRELOAD`攻击。    |                   |                     |
| **2.4.2**  | 代码-环境变量   | **必须项** | `PATH`环境变量不被外部调用者的环境变量覆盖                                   | **【代码语义分析】** **理解命令执行方式**，分析所有外部命令调用，确认是否使用绝对路径而非依赖PATH解析。                                                                                                                                                                                                                                                                                                                                                                                                           | 防止攻击者通过污染 `PATH`来执行非预期的恶意程序。                     |                   |                     |
| **3.1.1**  | 代码-命令执行   | **必须项** | **禁止**使用shell命令拼接执行（各语言等效模式）                          | **【多语言命令执行模式识别】** **理解代码中的命令执行逻辑**，识别各种语言的shell调用模式：``• **C/C++**: `system()`, `popen()`, `execl("/bin/sh")`• **Python**: `os.system()`, `subprocess.call("shell cmd", shell=True)`, `os.popen()`• **Go**: `exec.Command("sh", "-c", ...)`, `exec.Command("bash", ...)`• **Rust**: `Command::new("sh").arg("-c")`, `std::process::Command`• **通用**: 任何将字符串作为shell命令执行的模式 | shell命令拼接是最危险的命令注入形式，存在于所有编程语言中。             |                   |                     |
| **3.1.2**  | 代码-命令执行   | **必须项** | **禁止**使用进程创建函数调用shell解释器                                  | **【进程创建语义分析】** **理解进程创建意图**，识别所有创建shell解释器进程的代码：``• 第一个参数为shell路径 (`bash`, `sh`, `/bin/bash`, `/bin/sh`)``• 包含shell执行参数 (`-c`, `--command`)``• **分析命令内容来源**，确认是否存在外部输入拼接                                                                                                                                                                                                                           | 通过进程创建函数调用shell同样存在注入风险。                             |                   |                     |
| **3.2.1**  | 代码-命令参数   | **必须项** | 外部输入作为命令参数时，进行了严格的字符过滤与校验                             | **【数据流分析】** **跟踪外部输入的流向**，识别从D-Bus接口到命令执行的完整数据路径，确认在执行前是否对参数进行了严格校验。                                                                                                                                                                                                                                                                                                                                                                                        | 未校验的参数可能导致参数注入，改变原有命令的行为。                      |                   |                     |
| **3.2.2**  | 代码-命令参数   | **必须项** | 检查并过滤了危险字符：`; & \| \` ` $ ( ) < > [ ] { }`                       | **【代码语义分析】** **理解字符过滤逻辑**，在命令参数处理代码中确认是否存在shell元字符的检测和过滤机制。                                                                                                                                                                                                                                                                                                                                                                                                          | 这些是shell元字符，未经过滤会导致任意命令执行。                         |                   |                     |
| **4.1.1**  | 代码-文件操作   | **推荐项** | 敏感数据传输优先使用fd(memfd/pipefd)而非文件路径                               | **【代码语义分析】** **理解数据传输机制**，分析敏感数据的传递方式，确认是否使用了文件描述符而非临时文件。                                                                                                                                                                                                                                                                                                                                                                                                         | 使用fd可以从根本上避免文件路径相关的TOCTOU（时序竞态）攻击。            |                   |                     |
| **4.2.1**  | 代码-文件操作   | **必须项** | 所有文件路径都进行了规范化处理，并有效防止了路径遍历攻击 (`../`)             | **【路径处理分析】** **理解文件路径处理逻辑**，分析所有文件操作前的路径处理代码，确认是否进行了路径规范化和边界检查。                                                                                                                                                                                                                                                                                                                                                                                             | 防止攻击者通过操控路径访问到未授权的文件。                              |                   |                     |
| **5.1.1**  | 权限-Polkit配置 | **必须项** | 每个需要鉴权的特权操作，都有对应的Polkit action policy文件                     | **【配置文件审查】** 1. 查找项目中的Polkit策略文件(`*.policy`)。 2. 对比D-Bus接口中需要提权的方法，确认在policy文件中都有对应的action定义。                                                                                                                                                                                                                                                                                                                                                                           | Polkit是进行细粒度权限控制的标准机制，必须为每个操作配置。              |                   |                     |
| **5.1.2**  | 权限-Polkit配置 | **必须项** | Polkit策略中 `allow_any` 和 `allow_inactive` 通常应为 `no`               | **【配置文件审查】** 读取所有 `*.policy`文件，确认 `<defaults>`中的 `<allow_any>`和 `<allow_inactive>`的值是否为 `no`。                                                                                                                                                                                                                                                                                                                                                                                       | `allow_any=yes`会绕过所有认证，`allow_inactive`则允许后台会话提权。 |                   |                     |
| **5.1.3**  | 权限-Polkit配置 | **必须项** | Polkit策略中正确配置了 `auth_self` 或 `auth_admin`                         | **【配置文件审查】** 读取所有 `*.policy`文件，根据action的敏感程度，确认 `<allow_active>`的值被合理地设置为 `auth_self`, `auth_admin`或 `auth_admin_keep`等。                                                                                                                                                                                                                                                                                                                                                 | 这是控制授权级别的核心，错误配置将导致权限过高或过低。                  |                   |                     |
| **5.2.1**  | 权限-Polkit代码 | **必须项** | DBus接口鉴权主体使用 `system-bus-name`，**禁止**使用 `unix-process`  | **【代码语义分析】** **理解权限检查逻辑**，如果代码中调用了Polkit鉴权接口，分析传递的主体类型，确认是否使用了安全的鉴权方式。                                                                                                                                                                                                                                                                                                                                                                                     | `unix-process`鉴权可被PID重用攻击绕过，`system-bus-name`更安全。    |                   |                     |
| **5.2.2**  | 权限-Polkit代码 | **必须项** | 代码中对需要鉴权的DBus方法，调用了Polkit的鉴权接口                             | **【代码语义分析】** **理解方法的执行流程**，审查所有需要特权的D-Bus方法，确认其内部是否调用了权限验证逻辑。                                                                                                                                                                                                                                                                                                                                                                                                      | 如果仅有策略而无代码调用，则Polkit策略形同虚设。                        |                   |                     |
| **6.1.1**  | 权限-Systemd    | **推荐项** | 避免服务使用 `User=root`，优先使用低权限用户                                 | **【配置文件审查】** 读取systemd服务文件(`.service`)，检查是否存在 `User=root`，或者没有 `User`字段（默认为root）。                                                                                                                                                                                                                                                                                                                                                                                               | 遵循最小权限原则，即使服务被攻破，也能将损害降到最低。                  |                   |                     |
| **6.2.1**  | 权限-Systemd    | **必须项** | service文件配置了文件系统保护，如 `ProtectSystem=strict`                     | **【配置文件审查】** 读取systemd服务文件，检查是否配置了 `ProtectSystem`属性。                                                                                                                                                                                                                                                                                                                                                                                                                                        | 防止服务意外或恶意地修改系统关键目录 `/usr`, `/boot`, `/etc`。    |                   |                     |
| **6.2.2**  | 权限-Systemd    | **必须项** | service文件配置了 `PrivateTmp=yes`                                           | **【配置文件审查】** 读取systemd服务文件，检查是否配置了 `PrivateTmp=yes`。                                                                                                                                                                                                                                                                                                                                                                                                                                           | 为服务提供独立的临时目录，防止与其他进程发生临时文件冲突。              |                   |                     |
| **6.2.3**  | 权限-Systemd    | **必须项** | service文件通过 `ReadOnlyPaths` 和 `ReadWritePaths` 严格限制了文件访问     | **【配置文件审查】** 读取systemd服务文件，检查是否通过 `ReadOnlyPaths`和 `ReadWritePaths`严格限制了服务的文件访问范围。                                                                                                                                                                                                                                                                                                                                                                                             | 最小化服务的文件系统暴露面，防止其读写未授权的文件。                    |                   |                     |
| **6.3.1**  | 权限-Systemd    | **推荐项** | service文件使用 `CapabilityBoundingSet` 限制了Linux Capabilities             | **【配置文件审查】** 读取systemd服务文件，检查是否使用了 `CapabilityBoundingSet`来移除服务不需要的内核权能。                                                                                                                                                                                                                                                                                                                                                                                                          | 即使以root运行，也只授予服务运行所必需的最小特权，降低风险。            |                   |                     |
| **7.1.1**  | 质量-线程安全   | **必须项** | DBus method实现是线程安全的，共享资源有同步机制保护                            | **【代码语义分析】** **理解并发处理逻辑**，审查D-Bus方法实现，识别共享资源访问，确认是否有适当的同步机制。                                                                                                                                                                                                                                                                                                                                                                                                        | 线程不安全会导致数据竞争、状态不一致和程序崩溃。                        |                   |                     |
| **7.2.1**  | 质量-异步处理   | **推荐项** | 耗时操作实现为异步，避免阻塞DBus主线程                                         | **【代码语义分析】** **理解方法执行流程**，识别潜在的耗时操作，确认它们是否会阻塞主线程。                                                                                                                                                                                                                                                                                                                                                                                                                         | 同步的耗时操作会拖慢整个DBus总线，影响系统响应性。                      |                   |                     |
| **8.1.1**  | 质量-错误处理   | **必须项** | 所有错误和异常都被正确处理，失败时有安全的默认行为                             | **【代码语义分析】** **理解错误处理流程**，审查关键代码路径的错误处理逻辑，确认失败场景下的安全性。                                                                                                                                                                                                                                                                                                                                                                                                               | 错误处理不当可能导致信息泄露、拒绝服务或进入不安全状态。                |                   |                     |
| **8.2.1**  | 质量-日志记录   | **必须项** | 日志中不记录密码、token等任何敏感信息                                          | **【代码语义分析】** **理解日志内容**，分析所有日志记录点，确认记录的数据不包含敏感信息。                                                                                                                                                                                                                                                                                                                                                                                                                         | 防止敏感信息通过日志文件泄露。                                          |                   |                     |
| **9.1.1**  | 质量-内存安全   | **必须项** | 无内存泄漏、double free、野指针等内存管理问题                                  | **【代码语义分析+工具辅助】** **理解内存管理逻辑**，分析资源分配和释放，优先依赖静态/动态分析工具结果。                                                                                                                                                                                                                                                                                                                                                                                                           | 内存安全漏洞可能导致程序崩溃，甚至可能被利用来执行任意代码。            |                   |                     |
| **10.1.1** | 设计-接口版本   | **推荐项** | 接口有版本化设计，并考虑了向后兼容性                                           | **【接口设计分析】** **理解接口演进策略**，检查接口定义中的版本管理机制。                                                                                                                                                                                                                                                                                                                                                                                                                                         | 缺乏版本管理会导致API不稳定，给客户端适配带来困难。                     |                   |                     |
| **10.2.1** | 设计-接口隐藏   | **推荐项** | 通过配置或代码隐藏了不应暴露的内部接口                                         | **【接口暴露分析】** **理解接口暴露范围**，确认只有必要的接口被暴露给外部调用。                                                                                                                                                                                                                                                                                                                                                                                                                                   | 减少攻击面，避免内部实现细节的泄露。                                    |                   |                     |

---

## 🚨 命令调用专项审查 (必须执行)

**在完成上述所有检查项后，必须执行以下专项审查：**

### 步骤1：全面识别命令执行点

**目标**: 找出项目中所有可能执行外部命令的代码位置

**方法**:

1. **代码语义分析** - 通过阅读代码理解功能逻辑，识别需要调用外部程序的场景
2. **跨语言模式识别** - 根据项目语言特点，识别命令执行API：

**常见模式 (按语言分类)**:

```
C/C++: system(), popen(), execve(), execl(), QProcess
Python: os.system(), subprocess.*, os.popen(), commands.*
Go: exec.Command(), os/exec包
Rust: std::process::Command, std::process::Stdio
Java: Runtime.exec(), ProcessBuilder
JavaScript/Node.js: child_process.exec(), child_process.spawn()
Shell: 直接命令调用, $(command), `command`
```

### 步骤2：命令构造方式分析

**对每个命令执行点，分析**:

1. **命令内容来源** - 是硬编码、配置文件、用户输入还是混合？
2. **参数传递方式** - 是字符串拼接、参数数组还是其他方式？
3. **shell解释器使用** - 是否通过shell解释器 (`sh -c`, `bash -c`) 执行？
4. **外部输入影响** - 用户输入是否能影响执行的命令或参数？

### 步骤3：安全风险评估

**对每个命令执行进行风险等级评估**:

- 🔴 **高风险**: 使用shell解释器 + 外部输入拼接
- 🟡 **中风险**: 外部输入作为参数但有基础过滤
- 🟢 **低风险**: 固定命令 + 严格参数验证
- ⚪ **无风险**: 完全硬编码的命令

### 步骤4：修复建议

**针对发现的问题提供具体修复方案**:

1. **消除shell拼接** - 改用参数数组方式
2. **参数严格验证** - 白名单验证、特殊字符过滤
3. **使用绝对路径** - 避免PATH污染攻击
4. **最小权限原则** - 限制命令执行权限

---

## 🎯 AI执行要点

### 1. **理解优于搜索**

- 不要机械地搜索关键字，要**理解代码的业务逻辑**
- 分析**数据流向**，追踪从输入到执行的完整路径
- 理解**函数调用语义**，而不仅仅是函数名匹配

### 2. **多语言适配**

- 根据项目实际使用的编程语言调整检查重点
- 理解不同语言中等效的危险操作模式
- 关注语言特有的安全陷阱

### 3. **上下文分析**

- 每个发现都要分析**完整的执行上下文**
- 确认**实际的安全影响**，而不仅仅是潜在风险
- 区分**真正的漏洞**和**误报**

### 4. **完整性保证**

- 确保**所有检查项都被执行**，不遗漏任何步骤
- **命令调用专项审查**必须在最后执行
- 提供**具体的证据**和**可操作的修复建议**

---
